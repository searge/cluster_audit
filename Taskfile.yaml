---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

vars:
  UV_ENV: "env VIRTUAL_ENV={{.PWD}}/.venv UV_CACHE_DIR=.uv-cache"

tasks:
  default:
    desc: Show available tasks
    cmds:
      - task --list

  install:
    desc: Install/update dependencies
    cmds:
      - "{{.UV_ENV}} uv sync"

  audit:
    desc: Run standard audit
    cmds:
      - "{{.UV_ENV}} uv run python resource_audit.py --mode current"

  audit-extended:
    desc: Run extended operational audit
    cmds:
      - "{{.UV_ENV}} uv run python resource_audit.py --mode extended"

  workload-efficiency:
    desc: Generate workload resource efficiency CSV report
    aliases: [we]
    cmds:
      - "{{.UV_ENV}} uv run python simple_resource_table.py"

  rancher:
    desc: Run Rancher project analysis
    cmds:
      - "{{.UV_ENV}} uv run python simple_rancher_analyzer.py"

  rancher-users:
    desc: Map namespaces to Rancher projects and list project users
    cmds:
      - "{{.UV_ENV}} uv run python rancher_project_users.py --namespaces \"{{.NAMESPACES | default .CLI_ARGS}}\""

  rbac:
    desc: Run RBAC analysis
    cmds:
      - "{{.UV_ENV}} uv run python k8s_rbac_analyzer.py"

  dashboard:
    desc: Generate audit dashboard
    cmds:
      - "{{.UV_ENV}} uv run python audit_dashboard.py"

  lint:
    desc: Run code quality checks
    cmds:
      - "{{.UV_ENV}} uv run ruff format ."
      - "{{.UV_ENV}} uv run ruff check --fix ."

  typecheck:
    desc: Run type checking
    cmds:
      - "{{.UV_ENV}} uv run python -m mypy ."
      - "{{.UV_ENV}} uv run pyright ."

  test:
    desc: Run all checks
    deps: [lint, typecheck]
    cmds:
      - echo "âœ… All checks passed"

  clean:
    desc: Clean up old report files (>14 days)
    cmds:
      - find reports/ -name "*.csv" -type f -mtime +14 -delete
      - find reports/ -name "*.md" -type f -mtime +7 -delete
      - echo "ğŸ—‘ï¸ Cleanup completed"

  all:
    desc: Run complete analysis suite
    cmds:
      - task: audit
      - task: rancher
      - task: rbac
      - task: dashboard
